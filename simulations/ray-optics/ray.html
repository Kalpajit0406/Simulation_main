<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Julia Ray Optics Simulator</title>
  <meta name="viewport" content="width=1280, initial-scale=1.0">
  <style>
    body { background: #f5f7fa; font-family: sans-serif; }
    #simCanvas { background: #e3f2fd; border-radius: 18px; border: 2px solid #b3e0fc; margin: 24px; }
    .controls { margin: 24px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@wasmer/wasm@1.0.2/dist/wasm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@juliawasm/julia@1.10.3/dist/julia.js"></script>
</head>
<body>
  <h1>Ray Optics Simulator (Julia + WebAssembly)</h1>
  <canvas id="simCanvas" width="900" height="500"></canvas>
  <div class="controls">
    <button onclick="window.juliaMain()">Run Julia Simulation</button>
  </div>
  <script type="text/julia" id="julia-sim">
using JSCall

function draw_scene()
    ctx = @js window.simCanvas.getContext("2d")
    W = 900; H = 500

    # Clear
    @js ctx.clearRect(0,0,W,H)

    # Draw axis
    @js ctx.beginPath()
    @js ctx.setLineDash([8,8])
    @js ctx.moveTo(0, H/2)
    @js ctx.lineTo(W, H/2)
    @js ctx.strokeStyle = "#aaa"
    @js ctx.lineWidth = 2
    @js ctx.stroke()
    @js ctx.setLineDash([])

    # Draw lens (convex)
    lens_x, lens_y, lens_f = 450, H/2, 120
    @js ctx.save()
    @js ctx.translate(lens_x, lens_y)
    @js ctx.beginPath()
    @js ctx.ellipse(0, 0, 18, 60, 0, 0, 2*pi)
    @js ctx.fillStyle = "rgba(25, 118, 210, 0.13)"
    @js ctx.fill()
    @js ctx.strokeStyle = "#1976d2"
    @js ctx.lineWidth = 4
    @js ctx.stroke()
    @js ctx.restore()

    # Draw mirror
    mirror_x, mirror_y = 700, H/2
    @js ctx.save()
    @js ctx.translate(mirror_x, mirror_y)
    @js ctx.strokeStyle = "#888"
    @js ctx.lineWidth = 10
    @js ctx.beginPath()
    @js ctx.moveTo(-40, 0)
    @js ctx.lineTo(40, 0)
    @js ctx.stroke()
    @js ctx.restore()

    # Draw rays
    for y0 in (H÷2 - 40):20:(H÷2 + 40)
        ray_x, ray_y, ray_angle = 100.0, y0, 0.0
        px, py, angle = ray_x, ray_y, ray_angle
        @js ctx.save()
        @js ctx.strokeStyle = "#e67e22"
        @js ctx.lineWidth = 2.5
        @js ctx.beginPath()
        @js ctx.moveTo(px, py)
        # Step 1: to lens
        dx, dy = cos(angle), sin(angle)
        t_lens = (lens_x - px) / dx
        py_lens = py + t_lens * dy
        if abs(py_lens - lens_y) < 60
            @js ctx.lineTo(lens_x, py_lens)
            # Thin lens equation
            s = (lens_x - px)
            f = lens_f
            s2 = 1 / (1/f - 1/s)
            img_x = lens_x + s2
            img_y = lens_y
            out_angle = atan((img_y - py_lens) / (img_x - lens_x))
            # Step 2: to mirror
            dx2, dy2 = cos(out_angle), sin(out_angle)
            t_mirror = (mirror_x - lens_x) / dx2
            py_mirror = py_lens + t_mirror * dy2
            if abs(py_mirror - mirror_y) < 40
                @js ctx.lineTo(mirror_x, py_mirror)
                # Reflect
                out_angle2 = pi - out_angle
                # Step 3: after mirror
                dx3, dy3 = cos(out_angle2), sin(out_angle2)
                @js ctx.lineTo(mirror_x + 200*dx3, py_mirror + 200*dy3)
            else
                @js ctx.lineTo(lens_x + 400*dx2, py_lens + 400*dy2)
            end
        else
            @js ctx.lineTo(lens_x + 400*dx, py + 400*dy)
        end
        @js ctx.stroke()
        @js ctx.restore()
    end
end

draw_scene()
  </script>
  <script>
    // Load Julia and run the simulation
    window.juliaMain = async function() {
      if (!window.Julia) {
        alert("Julia runtime not loaded!");
        return;
      }
      const code = document.getElementById('julia-sim').textContent;
      await Julia.eval(code);
    };
    // Run on load
    window.onload = window.juliaMain;
  </script>
</body>
</html>